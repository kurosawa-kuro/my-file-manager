# Next.js ローカル動画ファイラー（改訂版）

## 1. 前提条件

* **開発環境**: Node.js 18 以上 / npm 9 以上
* **フレームワーク**: Next.js (Pages Router, JavaScript)
* **UI**: Tailwind CSS（任意）
* **対象ディレクトリ**: `C:\Users\owner\Downloads\Video`（※ Node.js プロセスからのみ参照）
* **対象拡張子**: `.mp4`, `.mkv`, `.mov`, `.avi`, `.webm`

---

## 2. ディレクトリ構成

```text
my-filer/
├── pages/
│   ├── index.js          # 一覧表示 UI
│   └── api/
│       └── files.js      # ファイル走査 API
├── lib/
│   └── listFiles.js      # 再帰探索ロジック
├── public/
├── styles/
│   └── globals.css
├── .env.local            # VIDEO_DIR の定義
├── next.config.js
└── package.json
```

---

## 3. 実装詳細

### 3‑1 `lib/listFiles.js`

```js
import fs from 'fs';
import path from 'path';

const VIDEO_EXT = new Set(['.mp4', '.mkv', '.mov', '.avi', '.webm']);

export function listVideoFiles(dir) {
  return fs.readdirSync(dir).flatMap((name) => {
    const full = path.join(dir, name);
    const stat = fs.statSync(full);

    if (stat.isDirectory()) return listVideoFiles(full);
    if (VIDEO_EXT.has(path.extname(full).toLowerCase())) return [full];
    return [];
  });
}
```

### 3‑2 `pages/api/files.js`

```js
import { listVideoFiles } from '../../lib/listFiles.js';

export default function handler(_, res) {
  const { VIDEO_DIR } = process.env;

  if (!VIDEO_DIR) {
    return res
      .status(500)
      .json({ error: '環境変数 VIDEO_DIR が未設定です。' });
  }

  try {
    const files = listVideoFiles(VIDEO_DIR);
    res.status(200).json({ files });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: 'ファイル一覧の取得に失敗しました。' });
  }
}
```

### 3‑3 `pages/index.js`

```js
import { useEffect, useState } from 'react';

export default function Home() {
  const [files, setFiles] = useState([]);

  useEffect(() => {
    (async () => {
      try {
        const res = await fetch('/api/files');
        const data = await res.json();
        setFiles(data.files ?? []);
      } catch (e) {
        console.error(e);
      }
    })();
  }, []);

  return (
    <main className="p-6">
      <h1 className="text-2xl font-semibold mb-4">動画ファイル一覧</h1>
      <ul className="space-y-1 list-disc pl-6 break-all">
        {files.map((f) => (
          <li key={f}>{f}</li>
        ))}
      </ul>
    </main>
  );
}
```

### 3‑4 `.env.local`（追加）

```
VIDEO_DIR=C:\\Users\\owner\\Downloads\\Video
```

---

## 4. 起動方法

```bash
npm install
npm run dev -- -p 8080
```

ブラウザで `http://localhost:8080` を開くと、環境変数 `VIDEO_DIR` で指定したフォルダ以下の動画ファイルが再帰的に表示されます。

---

## 5. セキュリティ & 運用上の注意

| 項目          | 説明                                                                              |
| ----------- | ------------------------------------------------------------------------------- |
| **ローカル限定**  | Node.js がローカルディスクに直接アクセスするため、クラウド上にデプロイしてもファイルは読めません。**Vercel などへのデプロイは非対応**です。 |
| **パスの固定**   | 任意のパスをクエリや Body で受け取らない設計にし、ディレクトリ・トラバーサルを防ぎます。                                 |
| **パフォーマンス** | 対象フォルダが極端に大きい場合、API 応答が遅くなります。必要に応じてキャッシュやページネーションを検討してください。                    |

---

## 6. 拡張アイデア

* 動画サムネイル／プレビュー表示（`<video>` タグ or `next/image`）
* ファイル名／タグによるフィルタリング
* 視聴履歴の jsondb/lowdb 保存
* Electron でデスクトップアプリ化

---

> 構造整理と環境変数対応により、可読性と安全性を高めました。追加改良のご要望があればお知らせください。
